---
title: "coding_Ruiqi"
author: "Ruiqi Yan (ry2417)"
date: "4/20/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(ggplot2)
library(maps)
library(data.table)
library(tidyverse)
library(doParallel)
```

# Hurrican Data
hurricane703.csv collected the track data of 703 hurricanes in  the North Atlantic area since 1950. For all the storms, their location (longitude \& latitude) and maximum wind speed were recorded every 6 hours. The data includes the following variables 

1. **ID**:  ID of the hurricanes
2. **Season**: In which \textbf{year} the hurricane occurred 
3. **Month**: In which \textbf{month} the hurricane occurred 
4. **Nature**:  Nature of the hurricane 
  + ET: Extra Tropical
  + DS: Disturbance
  + NR: Not Rated
  + SS: Sub Tropical
  + TS: Tropical Storm
5. **time**: dates and time of the record  
6. **Latitude** and **Longitude**:  The location of  a hurricane check point 
7. **Wind.kt**  Maximum wind speed (in Knot) at each check point 

## load and clean data

```{r}
load("df_rm.RData")
df_rm
dt = df_rm %>% 
  janitor::clean_names() %>% 
  group_by(id) %>% 
  mutate(wind_lag = lag(wind_kt,1),
         lat_shift = lag(latitude, 1) - lag(latitude, 2),
         long_shift = lag(longitude, 1) - lag(longitude, 2),
         wind_shift = lag(wind_kt, 1) - lag(wind_kt, 2)) %>% 
  drop_na()

n_freq = dt %>% group_by(id) %>% count() %>% pull(n)
df_mcmc = dt %>% 
  select(id,wind_kt,wind_lag,lat_shift, long_shift, wind_shift) %>% 
  nest(y = wind_kt, x_matrix=wind_lag:wind_shift) %>% 
  mutate(x_matrix = map(.x = x_matrix, ~model.matrix(~., data = .x)),
         y = map(y, pull))
y_obs = df_mcmc$y
x_matrix = df_mcmc$x_matrix
n_obs = nrow(dt)

obs_list = list(y_obs = y_obs,
           x_matrix = x_matrix)
d = 5
n_beta = nrow(df_mcmc)*d
n_theta = 3426
m = 681
rep_time = rep(n_freq,d)
```


```{r}
numCores <- detectCores()

log_posterior_beta = function(theta, sigma_p, j){
  sigma = theta[3411]
  mu = theta[3406:3410]
  x = obs_list$x_matrix[[j]]
  y = obs_list$y_obs[[j]]
  beta = matrix(theta[1:3405], ncol = 5)[j,]
  return(-t(y - x %*% beta) %*% (y - x %*% beta)/(2*sigma)-(1/2)*t(beta-mu)%*%sigma_p%*%(beta-mu))
}

log_posterior_mu = function(theta, sigma_p){
  beta = matrix(theta[1:3405], nrow = 5, byrow = T)
  sigma = theta[3411]
  mu = theta[3406:3410]
  beta_mu = beta-mu
  res = t(beta_mu) %*% sigma_p %*% beta_mu
  return(-(1/2)*sum(diag(res)))
}

log_posterior_sigma = function(theta, sigma_p){
  n_obs = 20216
  beta = theta[1:3405]
  beta_frame = matrix(rep(beta,time = rep_time), ncol = 5)
  sigma = theta[3411]
  mu = theta[3406:3410]
  if(sigma <= 0){
    return(-Inf)
  } else{
    log_lik = -(n_obs/2)*log(sigma)-sum((dt$wind_kt-beta_frame[,1]-dt$wind_lag*beta_frame[,2]-dt$lat_shift*beta_frame[,3]-dt$long_shift*beta_frame[,4]-dt$wind_shift*beta_frame[,5])^2/(2*sigma))
    log_prior = -log(sigma)
    return(log_lik + log_prior)
  }
}

log_posterior_sigmap = function(theta){
  beta = matrix(theta[1:3405], nrow = 5, byrow = T)
  sigma = theta[3411]
  mu = theta[3406:3410]
  sigma_p = matrix(0,5,5)
  sigma_p[lower.tri(sigma_p, diag = TRUE)] = theta[3412:3426]
  sigma_p[upper.tri(sigma_p)] = t(sigma_p)[upper.tri(sigma_p)]
  if(min(eigen(sigma_p)$values) <= 0){
    return(-Inf)
  } else{
    beta_mu = beta-mu
    res = t(beta_mu) %*% sigma_p %*% beta_mu
    return((d+1+m/2)*log(det(sigma_p))-(1/2)*sum(diag(sigma_p))-(1/2)*sum(diag(res)))
  }
}

componentwiseMH=function(a, theta_0, nrep=10000, n_theta){
  theta = theta_0
  theta_chain = matrix(0, nrow = nrep, ncol = n_theta)
  for(i in 1:nrep){
    sigma_p = matrix(0,5,5)
    sigma_p[lower.tri(sigma_p, diag = TRUE)] = theta[seq(n_theta-14, n_theta)]
    sigma_p[upper.tri(sigma_p)] = t(sigma_p)[upper.tri(sigma_p)]
    # update beta by block of each hurricane
    for(j in 1:681){
      for(l in 0:4){
        prop = theta
        ind = j+681*l
        prop[ind] = prop[ind]+2*(runif(1)-0.5)*a[ind]
        if(log(runif(1)) < (log_posterior_beta(prop, sigma_p, j) -
                            log_posterior_beta(theta, sigma_p, j))){theta[ind] = prop[ind]
        
      }
      }
    }
    # update mu
    prop = theta
    prop[3406:3410] = prop[3406:3410]+2*(runif(5)-0.5)*a[3406:3410]
    if(log(runif(1)) < (log_posterior_mu(prop, sigma_p) - log_posterior_mu(theta, sigma_p))){
      theta[3406:3410] = prop[3406:3410]
    }
    # update sigma
    prop = theta
    prop[3411] = prop[3411]+2*(runif(1)-0.5)*a[3411]
    if(log(runif(1)) < (log_posterior_sigma(prop, sigma_p) - log_posterior_sigma(theta, sigma_p))){
      theta[3411] = prop[3411]
    }
    # update sigma matrix
    for(j in 3412:3426){
        prop = theta
        prop[j] = prop[j]+2*(runif(1)-0.5)*a[j]
        if(log(runif(1)) < (log_posterior_sigmap(prop) - log_posterior_sigmap(theta))){
          theta[j] = prop[j]
        }
      }
    theta_chain[i,] = theta
  }
  return(theta_chain)
}

blockwiseMH=function(a, theta_0, nrep=10000, n_theta){
  theta = theta_0
  theta_chain = matrix(0, nrow = nrep, ncol = n_theta)
  for(i in 1:nrep){
    sigma_p = matrix(0,5,5)
    sigma_p[lower.tri(sigma_p, diag = TRUE)] = theta[seq(n_theta-14, n_theta)]
    sigma_p[upper.tri(sigma_p)] = t(sigma_p)[upper.tri(sigma_p)]
    # update beta by block of each hurricane
    for(j in 1:681){
      ind =  c(j, j+681, j+681*2, j+681*3, j+681*4)
      prop = theta
      prop[ind] = prop[ind]+2*(runif(5)-0.5)*a[ind]
      if(log(runif(1)) < (log_posterior_beta(prop, sigma_p, j) - log_posterior_beta(theta, sigma_p, j))){
      theta[ind] = prop[ind]
    }
      
    }
    # update mu
    for (j in 3406:3410){
      prop = theta
      prop[j] = prop[j]+2*(runif(1)-0.5)*a[j]
      if(log(runif(1)) < (log_posterior_mu(prop, sigma_p) - log_posterior_mu(theta, sigma_p))){
      theta[j] = prop[j]
      }
    }
    # update sigma
    prop = theta
    prop[3411] = prop[3411]+2*(runif(1)-0.5)*a[3411]
    if(log(runif(1)) < (log_posterior_sigma(prop, sigma_p) - log_posterior_sigma(theta, sigma_p))){
      theta[3411] = prop[3411]
    }
    # update sigma matrix
    for(j in 3412:3426){
        prop = theta
        prop[j] = prop[j]+2*(runif(1)-0.5)*a[j]
        if(log(runif(1)) < (log_posterior_sigmap(prop) - log_posterior_sigmap(theta))){
          theta[j] = prop[j]
        }
      }
    theta_chain[i,] = theta
  }
  return(theta_chain)
}
```


```{r}
## search window

a2 = rep(0.05,681)
a2[c(62,89,134,403,506,522)] = 0.01
a2[c(4,16,19,24,31,43,45,52,54,68,83,93,94,96,112,117,118,121,125,134,136,140,141,157,158,163,182,206,225,249,255,261,306,332,333,335,344,345,371,397,400,431,415,416,427,433, 436,442,445,449,450,456,464,475,503,508,519,523,524,532,544,550,563,564,569,584,589,591,601,614,618,642,664)] = 0.02

a = c(rep(0.1, 681),a2,rep(c(0.07,0.07,0.07), each = 681),0.03,0.005,0.02,0.02,0.02, 1, 3,10,3,3,4,55,15,15,15,5,3,5,5,5,6)

```


```{r}
beta_0 = lm(wind_kt~wind_lag+lat_shift+long_shift+ wind_shift, data = dt)
theta_0 = unname(c(rep(beta_0$coefficients, each = n_beta/d),beta_0$coefficients,mean((beta_0$residuals)^2),1,0,0,0,0,1,0,0,0,1,0,0,1,0,1))

numunique = function(x){length(unique(x))}
set.seed(2022)
theta_chain = blockwiseMH(a, theta_0, nrep=10000, n_theta)


a_rate = apply(theta_chain, MARGIN = 2, numunique)/10000
a_rate[3406:3410]
a_matrix2 = matrix(a_rate[1:3405], ncol = 5)
range(a_rate)
```

```{r}
names = c(str_c(rep(str_c("beta_", 0:4),each = 681),"_", rep(1:m, d)),str_c("mu_", 0:4),"sigma")
for(i in 0:4){for(j in i:4){names = c(names, paste0("sigma_", i,j))}}
colnames(theta_chain) = names
theta_chain_1 = theta_chain[1:2000,]
theta_chain_2 = theta_chain[2001:3600,]
theta_chain_3 = theta_chain[3601:5200,]
theta_chain_4 = theta_chain[5201:6800,]
theta_chain_5 = theta_chain[6801:8400,]
theta_chain_6 = theta_chain[8401:10000,]
save(theta_chain_1, file = "mcmc_chain_1.RData")
save(theta_chain_2, file = "mcmc_chain_2.RData")
save(theta_chain_3, file = "mcmc_chain_3.RData")
save(theta_chain_4, file = "mcmc_chain_4.RData")
save(theta_chain_5, file = "mcmc_chain_5.RData")
save(theta_chain_6, file = "mcmc_chain_6.RData")
theta_chain_df = as_tibble(theta_chain)
write_csv(theta_chain_df, file = "mcmc_chain.csv")
```

```{r}
##mu
par(mfrow=c(3,3))
plot(theta_chain[,3406], type = "l")
plot(theta_chain[,3407], type = "l")
plot(theta_chain[,3408], type = "l")
plot(theta_chain[,3409], type = "l")
plot(theta_chain[,3410], type = "l")
plot(theta_chain[,3411], type = "l")
plot(theta_chain[,3412], type = "l")
plot(theta_chain[,3417], type = "l")
plot(theta_chain[,3421], type = "l")

plot(theta_chain[,2], type = "l")
plot(theta_chain[,681+2], type = "l")
plot(theta_chain[,681*2+2], type = "l")
plot(theta_chain[,681*3+2], type = "l")
plot(theta_chain[,681*4+2], type = "l")
plot(theta_chain[,3413], type = "l")
plot(theta_chain[,3418], type = "l")
plot(theta_chain[,3424], type = "l")
plot(theta_chain[,3426], type = "l")

par(mfrow=c(3,3))
hist(theta_chain[5001:10000,2], nclass = 150)
hist(theta_chain[5001:10000,681+2], nclass = 150)
hist(theta_chain[5001:10000,681*2+2], nclass = 150)
hist(theta_chain[5001:10000,681*3+2], nclass = 150)
hist(theta_chain[5001:10000,681*4+2], nclass = 150)
hist(theta_chain[5001:10000,3413], nclass = 150)
hist(theta_chain[5001:10000,3418], nclass = 150)
hist(theta_chain[5001:10000,3424], nclass = 150)
hist(theta_chain[5001:10000,3426], nclass = 150)

par(mfrow=c(3,3))
hist(theta_chain[5001:10000,3406], nclass = 150)
hist(theta_chain[5001:10000,3407], nclass = 150)
hist(theta_chain[5001:10000,3408], nclass = 150)
hist(theta_chain[5001:10000,3409], nclass = 150)
hist(theta_chain[5001:10000,3410], nclass = 150)
hist(theta_chain[5001:10000,3411], nclass = 150)
hist(theta_chain[5001:10000,3412], nclass = 150)
hist(theta_chain[5001:10000,3417], nclass = 150)
hist(theta_chain[5001:10000,3421], nclass = 150)
```

```{r}
bs_estimates = apply(theta_chain[5001:10000,], 2, mean)
mu = bs_estimates[3406:3410]
sigma = bs_estimates[3411]
cov_m = matrix(0,5,5)
cov_m[lower.tri(cov_m, diag = TRUE)] = bs_estimates[seq(n_theta-14, n_theta)]
cov_m[upper.tri(cov_m)] = t(cov_m)[upper.tri(cov_m)]
beta = matrix(bs_estimates[1:3405], ncol = d)
```


```{r}
dt_res = dt %>% 
  select(id, nature, season, month, wind_kt,wind_lag,lat_shift, long_shift, wind_shift) %>%
  nest(data = nature:wind_shift) %>% 
  ungroup() %>% 
  mutate(beta_0 = beta[,1],
         beta_1 = beta[,2],
         beta_2 = beta[,3],
         beta_3 = beta[,4],
         beta_4 = beta[,5]) %>% 
  unnest(data) %>% 
  mutate(wind_kt_pred = beta_0+beta_1*wind_lag+beta_2*lat_shift+beta_3*long_shift+beta_4*wind_shift)

dt_res
```

